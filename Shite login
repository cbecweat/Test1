<?php
error_reporting(0);
session_start();
require('db.php');
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;

require 'phpmailer/src/Exception.php';
require 'phpmailer/src/PHPMailer.php';
require 'phpmailer/src/SMTP.php';

// Function to get the client's IP address
function getIpAddr(){
    if (!empty($_SERVER['HTTP_CLIENT_IP'])){
        $ipAddr = $_SERVER['HTTP_CLIENT_IP'];
    } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])){
        $ipAddr = $_SERVER['HTTP_X_FORWARDED_FOR'];
    } else{
        $ipAddr = $_SERVER['REMOTE_ADDR'];
    }
    return $ipAddr;
}

// Check if form is submitted
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['submit'])) {
    $ip_address = getIpAddr();

    // Check if there are too many failed login attempts within 30 seconds
    $time_limit = time() - 30;
    $query4 = "SELECT COUNT(*) AS total_count FROM loginlogs WHERE IpAddress='$ip_address' AND TryTime > FROM_UNIXTIME($time_limit)";
    $result = mysqli_query($con, $query4);
    $check_login_row = mysqli_fetch_assoc($result);
    $total_count = $check_login_row['total_count'];

    if ($total_count >= 3) {
        $msg = "Too many failed login attempts. Please login after 30 seconds.";
    } else {
        $username = mysqli_real_escape_string($con, $_POST['username']);
        $password = mysqli_real_escape_string($con, $_POST['password']);

        // Hash the password before using it in the query
        $hashed_password = hash('sha256', $password);

        // Checking if user exists in the database
        $query5 = "SELECT * FROM `users` WHERE username='$username'";
        $result = mysqli_query($con, $query5);

        if (mysqli_num_rows($result) == 1) {
            $user_data = mysqli_fetch_assoc($result);
            
            $stored_password = $user_data['password'];
            
            // Compare hashed password from the database with the provided hashed password
            if ($hashed_password === $stored_password) {
                $_SESSION['IS_LOGIN'] = 'yes';
                $_SESSION['username'] = $username;

                // Reset login attempts for this IP
                mysqli_query($con, "DELETE FROM loginlogs WHERE IpAddress='$ip_address'");

                header("Location: index.php");
                exit();
            } else {
                // Insert login attempt with timestamp
                mysqli_query($con, "INSERT INTO loginlogs (IpAddress, TryTime) VALUES ('$ip_address', NOW())");

                $msg = "Please enter valid login details.";
            }
        
        }
    }
}

// Generate and store a unique token
if (empty($_SESSION['token'])) {
    $_SESSION['token'] = bin2hex(random_bytes(32));
}
$token = $_SESSION['token'];

// Process password reset request
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['reset_submit'])) {
    $emailReset = mysqli_real_escape_string($con, $_POST['emailReset']);
	
    
    // Validate email format
    if (!filter_var($emailReset, FILTER_VALIDATE_EMAIL)) {
        $reset_msg = "Invalid email address.";
    } else {
        // Insert token into tokens table
        $query = "INSERT INTO `tokens` (token, username, email, trn_date) VALUES ('$token', '$username', '$emailReset', NOW())";
        $result = mysqli_query($con, $query);
        
        if ($result) {
            try {
                // Initialize PHPMailer
                $mail = new PHPMailer(true);
                //Server settings
                $mail->SMTPDebug = 0;                      // Enable verbose debug output
                $mail->isSMTP();                            // Send using SMTP
                $mail->Host       = 'smtp.gmail.com';       // Set the SMTP server to send through
                $mail->SMTPAuth   = true;                   // Enable SMTP authentication
                $mail->Username   = 'wadams6090@gmail.com'; // SMTP username
                $mail->Password   = 'vytzxolpwhnsqdbf';        // SMTP password
                $mail->SMTPSecure = 'tls';                  // Enable TLS encryption
                $mail->Port       = 587;                    // TCP port to connect to

                //Recipients
                $mail->setFrom('your_email@gmail.com', 'Password Reset');
                $mail->addAddress($emailReset, 'Recipient'); // Add a recipient

                //Content
                $mail->isHTML(true);                                    // Set email format to HTML
                $mail->Subject = 'Password Reset Token';
                $mail->Body    = "This is your token number: <b>$token</b>.<br>Follow the link to reset your password: <a href='https://localhost/password_reset.php'>Reset Password</a>";

                $mail->send();
                $reset_msg = "Follow the link sent to your email to reset your password.";
            } catch (Exception $e) {
                $reset_msg = "Your reset token could not be sent. Mailer Error: {$mail->ErrorInfo}";
            }
        } else {
            $reset_msg = "Your reset token could not be sent. Please try again later.";
        }
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Login</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
        .error-message {
            color: red;
        }
    </style>
</head>
<body>
<div class="form">
    <h1>Log In</h1>
    <form action="" method="post" name="login">
        <input type="text" name="username" placeholder="Username" required />
        <input type="password" name="password" placeholder="Password" required />
        <input name="submit" type="submit" value="Login" />
        <?php if (isset($msg)) { ?>
            <div class="error-message"><?php echo $msg; ?></div>
        <?php } ?>
    </form>
    <p>Not registered yet? <a href='registration.php'>Register Here</a></p>
</div>

<div class="form">
    <h2>Reset Password</h2>
    <form action="" method="post">
        <input type="text" name="emailReset" placeholder="Enter Email" required />
        <input type="submit" name="reset_submit" value="Reset Password" />
        <?php if (isset($reset_msg)) { ?>
            <div class="error-message"><?php echo $reset_msg; ?></div>
        <?php } ?>
    </form>
</div>

</body>
</html>
