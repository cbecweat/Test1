<?php
// Include authentication check and database connection
include("auth.php");
require('db.php');

// Check if form is submitted for a specific blog post
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    if(isset($_POST['comment']) && isset($_POST['blog_id'])) {
        $comment = $_POST['comment'];
        $blog_id = $_POST['blog_id'];

        // Update the comments for the specific blog post in the database
        $update_sql = "UPDATE blog_posts SET comments = CONCAT(IFNULL(comments, ''), 'New Comment: $comment\n') WHERE id = $blog_id";
        if ($con->query($update_sql) === TRUE) {
            echo "Comment added successfully.";
        } else {
            echo "Error adding comment: " . $con->error;
        }
    }
}

// Query to retrieve blogs from the database
$sql = "SELECT * FROM blog_posts";
$result = $con->query($sql);

// Check if there are any blogs
if ($result->num_rows > 0) {
    // Output each blog
    while($row = $result->fetch_assoc()) {
        echo "<div>";
        echo "<h2>" . $row["title"] . "</h2>";
        echo "<p>" . $row["content"] . "</p>";

        // Display existing comments
        if (!empty($row["comments"])) {
            echo "<h3>Comments:</h3>";
            echo "<p>" . nl2br($row["comments"]) . "</p>";
        }

        // Form to add comments
        echo "<form method='post'>";
        echo "<input type='hidden' name='blog_id' value='" . $row["id"] . "'>";
        echo "<textarea name='comment' placeholder='Add your comment'></textarea>";
        echo "<input type='submit' value='Submit'>";
        echo "</form>";

        echo "</div>";
    }
} else {
    echo "No blogs found.";
}
?>
