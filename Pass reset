<?php
session_start();
require('db.php');

// If form submitted, process password reset request
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['username'], $_POST['email'], $_POST['token'], $_POST['password'])) {
    // Sanitize and escape user inputs
    $username = mysqli_real_escape_string($con, $_POST['username']);
    $email = mysqli_real_escape_string($con, $_POST['email']);
    $token = mysqli_real_escape_string($con, $_POST['token']);
    $password = mysqli_real_escape_string($con, $_POST['password']);
    
    // Hash the password before using it in the query
    $hashed_password = hash('sha256', $password);

    // Check if the provided username, email, and token exist in the tokens table
    $query = "SELECT * FROM tokens WHERE username = '$username' AND email = '$email' AND token = '$token'";
    $result = mysqli_query($con, $query);

    if ($result && mysqli_num_rows($result) == 1) {
        // Update the password for the given username and email
        $update_query = "UPDATE users SET password = '$hashed_password' WHERE username = '$username' AND email = '$email'";
        $update_result = mysqli_query($con, $update_query);
        
        if ($update_result) {
            echo "<h3>Password has been reset successfully.</h3>";
        } else {
            echo "<h3>Failed to reset password. Please try again.</h3>";
        }
    } else {
        echo "<h3>Invalid username, email, or token.</h3>";
    }
}
?>

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Password reset</title>
<link rel="stylesheet" href="css/style.css" />
</head>
<body>
<div class="form">
    <h2>Password Reset</h2>
    <form action="password_reset.php" method="post">
        <input type="text" name="username" placeholder="Username" required /><br>
        <input type="text" name="email" placeholder="Email" required /><br>
        <input type="text" name="token" placeholder="Token" required /><br>
        <input type="password" name="password" placeholder="New Password" required /><br>
        <input type="submit" value="Reset Password" />
    </form>
</div>
</body>
</html>
