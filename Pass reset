<?php
error_reporting(0);
session_start();
require('db.php');
if (isset($_REQUEST['username'])) {

    $username = stripslashes($_REQUEST['username']);
    $username = mysqli_real_escape_string($con, $username);
    
    $email = stripslashes($_REQUEST['email']);
    $email = mysqli_real_escape_string($con, $email);
    
    $token = stripslashes($_REQUEST['token']);
    $token = mysqli_real_escape_string($con, $token);
    
    $password = stripslashes($_REQUEST['password']);
    $password = mysqli_real_escape_string($con, $password);
    
    // Fetching salt for the user
    $query = "SELECT salt FROM `users` WHERE username='$username' AND email='$email'";
    $result = mysqli_query($con, $query);
    $row = mysqli_fetch_assoc($result);
    $salt = $row['salt'];

    $hashed_password = hash('sha256', $password . $salt); // Add salt to password before hashing

    $trn_date = date("Y-m-d H:i:s");

    // Adds the php entity that helps to prevent XSS attack
    htmlentities($username, ENT_QUOTES, 'UTF-8');
    htmlentities($email, ENT_QUOTES, 'UTF-8');
    htmlentities($password, ENT_QUOTES, 'UTF-8');
    
    $query = "SELECT username, email, token FROM tokens WHERE username = '$username' AND email = '$email' AND token = '$token'";
    $result = mysqli_query($con, $query);

    if ($result) {
        $query = "UPDATE users SET password = '$hashed_password' WHERE username = '$username' AND email = '$email'";    
        $result = mysqli_query($con, $query); 

        if ($result) {
            echo "<h3>Password has been reset successfully.</h3>";
        } else {
            echo "<h3>Failed to reset password. Please try again.</h3>";
        }
    } 
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Password reset</title>
    <link rel="stylesheet" href="css/style.css" />
</head>
<body>
    <html>
    <form action="password_reset.php" method="post">
        <p>Enter details to reset password</p>
        Username: <input type="text" name="username"><br>
        Email: <input type="text" name="email"><br>
        Token No: <input type="text" name="token"><br>
        New Password: <input type="text" name="password"><br>
        <input type="submit">
    </form>
</body>
</html>
