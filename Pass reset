<?php
session_start();
require('db.php');

// Function to generate a random token
function generateToken() {
    return bin2hex(random_bytes(32));
}

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $username = mysqli_real_escape_string($con, $_POST['username']);
    $email = mysqli_real_escape_string($con, $_POST['email']);
    $old_password = mysqli_real_escape_string($con, $_POST['old_password']);
    $password = mysqli_real_escape_string($con, $_POST['password']);
    $token = generateToken(); // Generate a token

    // Fetch the hashed password and salt from the database
    $query1 = "SELECT password, salt FROM users WHERE username = '$username' AND email = '$email'";
    $result1 = mysqli_query($con, $query1);

    if ($result1 && mysqli_num_rows($result1) == 1) {
        $user_data = mysqli_fetch_assoc($result1);
        $stored_password = $user_data['password'];
        $salt = $user_data['salt'];

        // Hash the old password with the existing salt
        $hashed_old_password = hash('sha256', $old_password . $salt);

        // Check if old password matches the stored password
        if ($stored_password === $hashed_old_password) {
            // Insert the token into the database
            $query2 = "INSERT INTO `tokens` (username, email, token, old_password) VALUES ('$username', '$email', '$token', '$hashed_old_password')";
            $result2 = mysqli_query($con, $query2);

            if ($result2) {
                // Send the token to the user's email
                $to = $email;
                $subject = 'Password Reset Token';
                $message = "Your password reset token is: $token";
                $headers = 'From: your_email@example.com' . "\r\n" .
                            'Reply-To: your_email@example.com' . "\r\n" .
                            'X-Mailer: PHP/' . phpversion();

                // Send email
                mail($to, $subject, $message, $headers);
                echo "<h3>Password reset token has been sent to your email.</h3>";
            } else {
                echo "<h3>Failed to generate token. Please try again.</h3>";
            }
        } else {
            echo "<h3>Invalid old password.</h3>";
        }
    } else {
        echo "<h3>Invalid username or email.</h3>";
    }
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Password reset</title>
    <link rel="stylesheet" href="css/style.css" />
</head>
<body>
    <form action="password_reset.php" method="post">
        <p>Enter details to reset password</p>
        Username: <input type="text" name="username"><br>
        Email: <input type="text" name="email"><br>
        Old Password: <input type="password" name="old_password"><br>
        New Password: <input type="password" name="password"><br>
        <input type="submit">
    </form>
</body>
</html>
