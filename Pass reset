<?php
session_start();
require('db.php');

if (isset($_REQUEST['username'])) {
    $username = stripslashes($_REQUEST['username']);
    $username = mysqli_real_escape_string($con, $username);
    
    $email = stripslashes($_REQUEST['email']);
    $email = mysqli_real_escape_string($con, $email);
    
    $token = stripslashes($_REQUEST['token']);
    $token = mysqli_real_escape_string($con, $token);
    
    $old_password = stripslashes($_REQUEST['old_password']);
    $old_password = mysqli_real_escape_string($con, $old_password);
    
    $password = stripslashes($_REQUEST['password']);
    $password = mysqli_real_escape_string($con, $password);
    
    // Fetch the hashed password, salt, and token from the database
    $query1 = "SELECT password, salt, token FROM users WHERE username = '$username' AND email = '$email'";
    $result1 = mysqli_query($con, $query1);
    
    if ($result1 && mysqli_num_rows($result1) == 1) {
        $user_data = mysqli_fetch_assoc($result1);
        $stored_password = $user_data['password'];
        $salt = $user_data['salt'];
        $stored_token = $user_data['token'];
        
        // Hash the old password with the existing salt
        $hashed_old_password = hash('sha256', $old_password . $salt);
        
        if ($stored_password === $hashed_old_password && $stored_token === $token) {
            // Hash the new password with the existing salt
            $hashed_password = hash('sha256', $password . $salt);
            
            // Update the password in the database
            $query2 = "UPDATE users SET password = '$hashed_password' WHERE username = '$username' AND email = '$email'";
            $result2 = mysqli_query($con, $query2);
            
            if ($result2) {
                echo "<h3>Password has been reset successfully.</h3>";
            } else {
                echo "<h3>Failed to reset password. Please try again.</h3>";
            }
        } else {
            echo "<h3>Invalid old password or token.</h3>";
        }
    } else {
        echo "<h3>Invalid username or email.</h3>";
    }
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Password reset</title>
    <link rel="stylesheet" href="css/style.css" />
</head>
<body>
    <form action="password_reset.php" method="post">
        <p>Enter details to reset password</p>
        Username: <input type="text" name="username"><br>
        Email: <input type="text" name="email"><br>
        Token No: <input type="text" name="token"><br>
        Old Password: <input type="password" name="old_password"><br>
        New Password: <input type="password" name="password"><br>
        <input type="submit">
    </form>
</body>
</html>
